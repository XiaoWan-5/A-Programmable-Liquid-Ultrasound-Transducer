clear; clc; close all;
% Constants
N = 500;                        % Number of particles
kb = 1.380649 * 1e-23;          % Boltzmann constant
T = 300;                        % Temperature
kT = kb * T;
mu0 = 4*pi*10^-7;               % Permeability of free space
H = [0, 0, 40000];              % External magnetic field (A/m)
Bext = mu0 * H;                 % Tesla
epsilon = 1e-22;                % potential well for WCA potential (J)
p_translate = 0.5;              % 50% translation
p_rotate    = 0.5;              % 50% rotation

% Particle properties
norm_d = 2e-8;                  % Normalized diameter of each particle (20 nm)
L = 20*norm_d;                  % Side length of the cubic box, 20 times as a example
d = norm_d * ones(N,1);         % Diameters
r = d(1)/2;                     % Radius of the particle (m)

% === Material parameters (Fe3O4, room temperature) ===
Ms = 480e3;                     % Saturation magnetization [A/m]
V  = (4/3)*pi*r^3;              % Particle volume [m^3]
m0 = Ms * V;                    % Fixed magnetic moment magnitude [A·m^2]

% === Initialize magnetic moments (superparamagnetic model) ===
% Each particle has a rigid single-domain moment with random orientation
v = randn(N,3);                 % Random directions
v_unit = v ./ vecnorm(v,2,2);   % Row-wise normalization
m = m0 * v_unit;                % Fixed |m|, random orientation

% === Initialize non-overlapping position ===
positions = zeros(N,3);
alpha = 1;                      % safety factor (>1 avoids near-contact singularities)
maxTrials = 1e5;                % prevent infinite loop
positions = overlap_initial(positions,alpha,maxTrials,N,L,d);

% Monte Carlo Parameters
nSteps = 1000000;
stepSize = 0.1 * norm_d;       
maxAngle = 0.2;                 % rad, ~11°

% Acceptance statistics
totalAccepted = 0;
totalProposed = 0; 

% Main Simulation Loop
for step = 1:nSteps
    i = randi(N);
    totalProposed = totalProposed + 1;

    if rand < p_translate
        % Translation move
        newPosition = positions(i,:) + stepSize * randn(1,3);
        % hard wall
        if any(newPosition < 0) || any(newPosition > L)
            continue
        end

        % translation: m_old = m_new = current m(i,:)
        DeltaE = calculateEnergyChange(i, newPosition, positions, m(i,:), m(i,:), m, d, mu0, epsilon, Bext, L);

        if (DeltaE <= 0) || (rand < exp(-DeltaE / kT))
            positions(i,:) = newPosition;
            totalAccepted = totalAccepted + 1;
        end

    else
        % Rotation move
        m_old = m(i,:);
        m_new = propose_rotate(m_old, maxAngle);

        % rotation: position unchanged
        DeltaE = calculateEnergyChange(i, positions(i,:), positions, m_old, m_new, m, d, mu0, epsilon, Bext, L);

        if (DeltaE <= 0) || (rand < exp(-DeltaE / kT))
            m(i,:) = m_new;
            totalAccepted = totalAccepted + 1;
        end
    end
end

% Calculate and display the net magnetic moment in the x-direction,
net_magnetic_moment_x = sum(m(:,1));
disp(['Net Magnetic Moment in X direction: ', num2str(net_magnetic_moment_x)]);

% Calculate and display the acceptance rate
acceptanceRate = totalAccepted / totalProposed;
disp(['Acceptance Rate: ', num2str(acceptanceRate)]);
